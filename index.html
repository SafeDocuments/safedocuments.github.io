<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Safe Documents - Public Share</title>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.9.359/pdf.min.js"></script>
    <style>
        * { box-sizing: border-box; }
        body, html { margin: 0; padding: 0; height: 100%; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif; background-color: #0f0f0f; color: #f7f7f7; overflow: hidden; user-select: none; }
        .main-container { display: flex; flex-direction: column; height: 100vh; max-width: 1400px; margin: 0 auto; padding: 15px; background-color: rgba(20,20,20,0.95); backdrop-filter: blur(10px); }
        #top-bar { display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; background: linear-gradient(135deg, #1e1e1e 0%, #282828 100%); border-radius: 12px; margin-bottom: 15px; }
        .controls-left, .controls-center, .controls-right { display: flex; align-items: center; gap: 10px; }
        .controls-center { flex-grow: 1; justify-content: center; gap: 20px; }
        #fileInput { display: none; }
        label, button { padding: 10px 20px; background: linear-gradient(135deg, #00a86b 0%, #00c77f 100%); border: none; border-radius: 8px; color: white; cursor: pointer; font-size: 14px; transition: all 0.3s ease; }
        label:hover, button:hover { background: linear-gradient(135deg, #007bff 0%, #0056b3 100%); }
        button:disabled { background: #444; cursor: not-allowed; opacity: 0.6; }
        .pdf-container { flex-grow: 1; display: flex; gap: 15px; overflow: hidden; }
        #sidebar { width: 180px; background: rgba(30,30,30,0.9); border-radius: 12px; padding: 10px; overflow-y: auto; }
        .thumbnail { margin-bottom: 10px; cursor: pointer; position: relative; }
        .thumbnail canvas { width: 100%; display: block; }
        .thumbnail.active { box-shadow: 0 0 0 3px #00a86b; }
        .page-label { position: absolute; bottom: 5px; right: 5px; background: rgba(0,0,0,0.8); color: white; padding: 2px 8px; border-radius: 4px; font-size: 12px; }
        #pdf-viewer { flex-grow: 1; position: relative; background: #1a1a1a; border-radius: 12px; overflow: hidden; }
        #pdf-content { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; overflow: auto; }
        #pdf-canvas-container { position: relative; box-shadow: 0 0 20px rgba(0,0,0,0.5); border-radius: 8px; margin: 20px; }
        canvas { background: white; }
        #navigation, #zoom-controls, #pan-controls-header { display: flex; align-items: center; gap: 10px; background: rgba(40,40,40,0.9); padding: 8px; border-radius: 8px; }
        .nav-button, .zoom-button, .pan-button-small { background: rgba(60,60,60,0.9); border: 1px solid rgba(100,100,100,0.3); color: white; font-size: 16px; padding: 8px; cursor: pointer; }
        .zoom-button, .pan-button-small { width: 36px; height: 36px; display: flex; justify-content: center; align-items: center; }
        #fit-button { padding: 8px 15px; }
        #statusMessage { position: fixed; bottom: 20px; right: 20px; padding: 12px 20px; background: rgba(40,40,40,0.95); border-radius: 8px; display: none; }
        #statusMessage.show { display: block; animation: slideIn 0.3s ease; }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
        #shareableLinkModal { display: none; position: fixed; z-index:2000; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.9); backdrop-filter:blur(5px); }
        #shareableLinkModalContent { background: #2a2a2a; margin:10% auto; padding:30px; width:90%; max-width:500px; text-align:center; border-radius:16px; }
        #shareableLink { background: #141414; padding:15px; border-radius:8px; word-break:break-all; font-family:monospace; }
    </style>
</head>
<body>
    <div class="main-container">
        <div id="top-bar">
            <div class="controls-left">
                <input type="file" id="fileInput" accept="application/pdf">
                <label for="fileInput">üìÑ Choose PDF</label>
                <button id="uploadButton" disabled>‚òÅÔ∏è Upload to Drive</button>
                <button id="generateLinkButton" disabled>üîó Generate Link</button>
            </div>
            <div class="controls-center">
                <div id="navigation">
                    <button class="nav-button" id="prev">‚óÄ</button>
                    <span id="page-num">Page 0 of 0</span>
                    <button class="nav-button" id="next">‚ñ∂</button>
                </div>
                <div id="zoom-controls">
                    <button class="zoom-button" id="zoom-out">‚àí</button>
                    <span id="zoom-level">100%</span>
                    <button class="zoom-button" id="zoom-in">+</button>
                    <button id="fit-button">Fit</button>
                </div>
                <div id="pan-controls-header">
                    <button class="pan-button-small" id="pan-up">‚Üë</button>
                    <button class="pan-button-small" id="pan-down">‚Üì</button>
                    <button class="pan-button-small" id="pan-left">‚Üê</button>
                    <button class="pan-button-small" id="pan-right">‚Üí</button>
                </div>
            </div>
<div class="controls-right"><span id="document-name"></span></div></div>
        <div class="pdf-container">
            <div id="sidebar"></div>
            <div id="pdf-viewer">
                <div id="pdf-content"><div id="pdf-canvas-container"><div class="loading-spinner"></div></div></div>
            </div>
        </div>
    </div>
    <div id="statusMessage"></div>
    <div id="shareableLinkModal">
        <div id="shareableLinkModalContent">
            <h2>üìã Shareable Link Generated</h2>
            <p id="shareableLink"></p>
            <button id="copyButton">üìã Copy Link</button>
        </div>
    </div>
    <script>
        const CLIENT_ID = '480657269781-3oo277sppsmm2qj1i7uku5dvfbncghsv.apps.googleusercontent.com';
        const API_KEY = 'AIzaSyCawbOm-B5FGvuFNszpZrrpkpOYugaGHE8';
        const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest';
        const SCOPES = 'https://www.googleapis.com/auth/drive.file';
        const FOLDER_ID = '1w17OEokh0z5o6MzXWjOYVUYITkW77Fnh';
        let tokenClient, gapiInited=false, gisInited=false;
        let currentPdf=null, currentPage=1, totalPages=0, currentFileId='', scale=1.5, currentZoom=100, fitScale=1.5;
        const fileInput=document.getElementById('fileInput'), uploadButton=document.getElementById('uploadButton'), generateLinkButton=document.getElementById('generateLinkButton');
        const shareModal=document.getElementById('shareableLinkModal'), linkDiv=document.getElementById('shareableLink'), copyBtn=document.getElementById('copyButton');
        pdfjsLib.GlobalWorkerOptions.workerSrc='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.9.359/pdf.worker.min.js';
        function gapiLoaded(){ gapi.load('client', initGapi); }
        async function initGapi(){ await gapi.client.init({apiKey:API_KEY, discoveryDocs:[DISCOVERY_DOC]}); gapiInited=true; maybeEnable(); checkURL(); }
        function gisLoaded(){ tokenClient=google.accounts.oauth2.initTokenClient({client_id:CLIENT_ID, scope:SCOPES, callback:''}); gisInited=true; maybeEnable(); }
        function maybeEnable(){ if(gapiInited && gisInited) uploadButton.disabled=false; }
        fileInput.addEventListener('change',()=>{ if(fileInput.files.length){ uploadButton.disabled=false; document.getElementById('document-name').textContent=fileInput.files[0].name; loadPDFFromFile(fileInput.files[0]);}});
        uploadButton.addEventListener('click',handleAuth);
        generateLinkButton.addEventListener('click',()=>{ const url=`https://drive.google.com/file/d/${currentFileId}/view?usp=sharing`; linkDiv.textContent=url; shareModal.style.display='block'; });
        copyBtn.addEventListener('click',()=>{ navigator.clipboard.writeText(linkDiv.textContent); showStatus('Link copied!', 'success'); setTimeout(()=>shareModal.style.display='none',1000); });
        function handleAuth(){ tokenClient.callback=async(resp)=>{ if(resp.error) return showStatus('Auth error','error'); await upload(); }; if(!gapi.client.getToken()) tokenClient.requestAccessToken({prompt:'consent'}); else tokenClient.requestAccessToken({prompt:''}); }
        async function upload(){ const file=fileInput.files[0]; if(!file) return showStatus('Select file first','error'); try{ showStatus('Uploading...'); const metadata={name:file.name, mimeType:file.type, parents:FOLDER_ID?[FOLDER_ID]:[]}; const form=new FormData(); form.append('metadata',new Blob([JSON.stringify(metadata)],{type:'application/json'})); form.append('file', file);
                const resp=await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id', {method:'POST', headers:{'Authorization':'Bearer '+gapi.auth.getToken().access_token}, body: form}); const res=await resp.json(); if(!resp.ok) throw new Error(res.error.message);
                currentFileId=res.id;
                // Make public
                await gapi.client.drive.permissions.create({ fileId: currentFileId, resource: { role: 'reader', type: 'anyone' } });
                showStatus('Uploaded & shared!', 'success'); generateLinkButton.disabled=false;
            }catch(e){ showStatus('Upload error: '+e.message,'error'); }
        }
        function showStatus(msg, type){ const s=document.getElementById('statusMessage'); s.textContent=msg; s.className='show'; setTimeout(()=>s.className='',4000); }
        // PDF.js helpers
        function loadPDFFromFile(file){ const reader=new FileReader(); reader.onload=()=>{ const ua=new Uint8Array(reader.result); pdfjsLib.getDocument(ua).promise.then(onPDF).catch(e=>showStatus('PDF load error','error')); }; reader.readAsArrayBuffer(file); }
        async function onPDF(pdf){ currentPdf=pdf; totalPages=pdf.numPages; currentPage=1; fitScale=await calcFit(); scale=fitScale; render(currentPage); genThumbs(); }
        async function calcFit(){ const p=await currentPdf.getPage(1); const vp=p.getViewport({scale:1}); const cw=document.getElementById('pdf-content').clientWidth-40; const ch=document.getElementById('pdf-content').clientHeight-40; const s=Math.min(cw/vp.width, ch/vp.height); return Math.max(0.5, Math.min(s, 3)); }
        async function render(pageNum){ const p=await currentPdf.getPage(pageNum); const vp=p.getViewport({scale}); const canvas=document.createElement('canvas'), ctx=canvas.getContext('2d'); const os=window.devicePixelRatio||1; canvas.width=Math.floor(vp.width*os); canvas.height=Math.floor(vp.height*os); canvas.style.width=Math.floor(vp.width)+'px'; const rc={canvasContext:ctx, viewport:vp, transform:os!==1?[os,0,0,os,0,0]:null}; await p.render(rc).promise; const c=document.getElementById('pdf-canvas-container'); c.innerHTML=''; c.appendChild(canvas); document.getElementById('page-num').textContent=`Page ${currentPage} of ${totalPages}`; }
        async function genThumbs(){ const sb=document.getElementById('sidebar'); sb.innerHTML=''; for(let i=1;i<=totalPages;i++){ const d=document.createElement('div'); d.className='thumbnail'+(i===1?' active':''); const c=document.createElement('canvas'), ctx=c.getContext('2d'); const p=await currentPdf.getPage(i); const vp=p.getViewport({scale:0.3}); c.width=vp.width; c.height=vp.height; await p.render({canvasContext:ctx, viewport:vp}).promise; d.appendChild(c); const lbl=document.createElement('div'); lbl.className='page-label'; lbl.textContent=i; d.appendChild(lbl); d.onclick=()=>{ currentPage=i; render(i); document.querySelectorAll('.thumbnail').forEach((t,idx)=>t.classList.toggle('active',idx+1===i)); }; sb.appendChild(d); }
        document.getElementById('prev').onclick=()=>{ if(currentPage>1){currentPage--; render(currentPage);} };
        document.getElementById('next').onclick=()=>{ if(currentPage<totalPages){currentPage++; render(currentPage);} };
        document.getElementById('zoom-in').onclick=()=>{ if(currentZoom<200){currentZoom+=25; scale=fitScale*(currentZoom/100); render(currentPage); document.getElementById('zoom-level').textContent=currentZoom+'%'; }};
        document.getElementById('zoom-out').onclick=()=>{ if(currentZoom>50){currentZoom-=25; scale=fitScale*(currentZoom/100); render(currentPage); document.getElementById('zoom-level').textContent=currentZoom+'%'; }};
        document.getElementById('fit-button').onclick=()=>{ currentZoom=100; scale=fitScale; render(currentPage); document.getElementById('zoom-level').textContent='100%'; };
        // URL params loader
        function checkURL(){ const params=new URLSearchParams(window.location.search); const id=params.get('fileId'); if(id){ loadFromDrive(id); }}
        async function loadFromDrive(id){ showStatus('Loading shared file'); const r=await fetch(`https://www.googleapis.com/drive/v3/files/${id}?alt=media&key=${API_KEY}`); if(!r.ok) return showStatus('Fetch error','error'); const b=await r.blob(); const ua=new Uint8Array(await b.arrayBuffer()); pdfjsLib.getDocument(ua).promise.then(onPDF).catch(()=>showStatus('PDF load error','error')); }
        // Init
        gapiLoaded(); gisLoaded();
    </script>
</body>
</html>
